<!DOCTYPE>
<html lang="zh-CN" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="../static/popper/popper.min.js"></script>
    <th:block th:include="common/header :: header(~{::title})">
        <title>瀚海云盘</title>
    </th:block>

    <!-- drawer.css -->
    <link rel="stylesheet" href="/static/drawer/drawer.min.css">
    <!-- iScroll.js -->
    <script src="/static/iScroll/iscroll.js"></script>
    <!-- drawer.js -->
    <script src="/static/drawer/drawer.min.js"></script>
    <!--    lemon-->
    <script src="/static/spark-md5.js"></script>
    <!-- 引入bootstrap-table.css	-->
    <link rel="stylesheet" href="/static/bootstrap-table/bootstrap-table.min.css">
    <!--	引入bootstrap-table.js -->
    <script src="/static/bootstrap-table/bootstrap-table.min.js"></script>
    <!--	引入bootstrap-table中文包 -->
    <script src="/static/bootstrap-table/bootstrap-table-zh-CN.min.js"></script>
    <!--  转换文件大小函数  -->
    <script src="/static/converFileSize.js"></script>
    <!--    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />-->
    <!--    <script src="./iconfont.js"></script>-->

    <style type="text/css">

        .actions {
            justify-content: left;
            padding: 0px;
        }

        .dropdown-item {
            font-size: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .actions button {
            margin-right: 10px;
            margin-left: 5px;
        }

        .statistical {
            margin-right: 5px;
        }

        table {
            font-size: 1.2rem;
            margin-left: 0px;
        }



        .files td i {
            display: none;
            /*padding: 5px;*/
            padding: 3px 6px 3px 5px;
            margin-right: 30px;
            font-size: 1.3rem;
            color: #007bff;
            cursor: pointer;
            border-radius: 50%;
        }

        .files td i:hover {
            background-color: #7abaff;
            color: white;
        }

        tr:hover > td > i {
            display: inline-block;
        }

        tbody tr:hover {
            background-color: rgb(244, 251, 255);
        }

        .files {
            line-height: 2rem;
        }

        table {
            margin-top: 5px;
            width: 100%;
        }

        /*.btn-outline-primary {*/
        /*    color: #000000;*/
        /*    border-color: #007bff;*/
        /*}*/

        .icon {
            width: 2em;
            height: 2em;
        }

        .filename {
            margin-top: 15px;
            margin-left: 135px;
            font-size: 15px;
        }

        fieldset {
            padding: .35em .625em .75em;
            margin: 10px 10px;
            border: 1px solid silver;
        }

        legend {
            padding: .5em;
            border: 0;
            width: auto;
        }

        .addbutton {
            margin-left: 10px;
            margin-top: 5px;
            font-size: 20px
        }

        .drawer-nav > ul > li {
            margin-top: 10px;
        }

        .drawer-nav li .bi {
            margin-top: -5px;
            padding-left: 5px;
            font-size: 20px;
            color: #5a6268;
            cursor: pointer;
        }

        .col-my-drawer {
            width: 400px;
        }

        .pointer {
            cursor: pointer;
        }

    </style>
    <script>
        const currentPath = "[[${current}]]";
    </script>

</head>
<body class="drawer drawer--right">
<div th:replace="common/nav-header :: nav-header"></div>
<div class="main">
    <div th:replace="common/nav-left :: nav-left"></div>

    <div class="content" style="overflow: hidden;margin-right: 1%">
        <!--    文件操作栏    -->
        <div class="row  navbar bg-light  actions">
            <div class="dropdown">
                <button type="button" class="btn btn-md btn-primary dropdown-toggle " data-toggle="dropdown"
                        aria-expanded="false" id="dropdownMenu2">
                    <span class="bi bi-cloud-upload"></span>&nbsp;上传
                </button>
                <div class="dropdown-menu" aria-labelledby="uploadButton">
                    <a class="dropdown-item" href="#" id="uploadFileMenuItem">上传文件</a>
                    <a class="dropdown-item" href="#" id="uploadFolderMenuItem">上传文件夹</a>
                </div>
            </div>
            <button type="button" class="btn btn-outline-primary btn-md" id="createFolder" data-toggle="modal"
                    data-target="#addfolderModel">
                <span class="bi bi-folder-plus"></span>&nbsp;新建文件夹
            </button>
            <button type="button" class="btn btn-outline-primary btn-md" id="download" disabled="disabled">
                <span class="bi bi-cloud-download"></span>下载
            </button>
            <button type="button" class="btn btn-outline-primary btn-md" id="deleted" disabled="disabled" data-toggle="modal"
                    data-target="#deleteConfirmation">
                <span class="bi bi-trash"></span>删除
            </button>
            <button type="button" class="btn btn-outline-primary btn-md" id="rename" disabled="disabled"
                    data-toggle="modal"
                    data-target="#renameModel">重命名
            </button>
            <button type="button" class="btn btn-outline-primary btn-md" id="copy" disabled="disabled">复制到</button>
            <button type="button" class="btn btn-outline-primary btn-md" id="move" disabled="disabled">移动到</button>
            <div class="form-inline ml-auto " style="margin-top:10px;">
                <input class="form-control mr-sm-2" type=".search" placeholder="搜索您的文件" aria-label="search" id="searchInput">
                <button class="btn btn-outline-success my-2 my-sm-0" id="searchBtn">
                    <i class="bi bi-search"></i>搜索
                </button>
            </div>
        </div>
        <!--    信息栏（返回上级、文件数）    -->
        <div class="row bg-light" style="margin-top: 5px; height: 3rem">
            <button type="button" class="btn btn-light btn-lg" id="parentBtn" parentPath="">
                <span class="bi bi-reply"></span>&nbsp;返回上一级
            </button>
            <span class="statistical ml-auto" id="counttext" style="margin-top: 8px ;margin-right: 30px">
                已全部加载，共<span id="fileNumber"></span>个文件
            </span>
        </div>
        <!--    文件列表    -->
        <table id="mTable" class="files " style="background-color: white"></table>
    </div>
</div>
<!--分享模态框-->
<div th:replace="common/shareModal :: shareModal"></div>
<!--选择目录模态框-->
<div th:replace="common/selectDir :: selectDir"></div>
<!-- 添加标签模态框 -->
<div class="modal" id="addTagModal">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">

            <!-- 模态框头部 -->
            <div class="modal-header">
                <h5 class="modal-title">添加标签</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body">
                <div class="row form-group">
                    <label class="col-form-label col-4 offset-1 text-right">标签名:</label>
                    <input type="text" name="newTag" class="form-control col-5" id="newTag" required placeholder="标签名">
                </div>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary addConfirm">确定</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<!-- 新建文件夹模态框 -->
<div class="modal" id="addfolderModel">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">

            <!-- 模态框头部 -->
            <div class="modal-header">
                <h5 class="modal-title">新建文件夹</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body">
                <div class="row form-inline">
                    <label class="col-form-label text-right">文件夹名:</label>
                    <input type="text" name="newTag" class="form-control " id="newfolder" required
                           placeholder="在此输入文件夹名">
                </div>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary addConfirm" id="addfolderconfirm">确定</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<!-- 重命名模态框 -->
<div class="modal" id="renameModel">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">

            <!-- 模态框头部 -->
            <div class="modal-header">
                <h5 class="modal-title">重命名</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body">
                <div class="row form-inline">
                    <label class="col-form-label text-right">新文件名:</label>
                    <input type="text" name="newname" class="form-control " id="newname" required
                           placeholder="在此新文件名">
                </div>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary addConfirm" id="renameconfirm">确定</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<!-- 删除标签模态框 -->
<div class="modal" id="delTagModal">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">

            <!-- 模态框头部 -->
            <div class="modal-header">
                <h5 class="modal-title">确认操作</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body mt-3 mb-3 ml-2 mr-2">
                您确定删除该标签么？<br/>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-danger delConfirm">确定</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>

        </div>
    </div>
</div>
<!-- 确认删除模态框 -->
<div class="modal" id="deleteConfirmation">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">

            <!-- 模态框头部 -->
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body">
                <div class="row form-inline">
                    <label class="col-form-label" Style="text-align: center;">确认要把所选文件放入回收站吗?</label>
                </div>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary addConfirm" id="confirmDeletion">确定</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<!--右侧抽屉-->
<nav class="drawer-nav" role="navigation" style="z-index: 20">
    <ul class="pl-0">
        <li class="text-center" style="width: 100%">
<!--                        <svg class="icon" aria-hidden="true">-->
<!--                            <use th:href="${'#icon-'+#strings.toLowerCase(file.getFileType())}"></use>-->
<!--                        </svg>-->
        </li>
        <li class="row">
<!--                        <span class="offset-2"></span>-->
<!--                        <span class="sInfo col-8 p-0 pr-2 text-center" title="" id="sFileName"></span>-->
        </li>
        <hr>
        <fieldset>
            <legend>标签管理</legend>
            <div class="row" style="margin-top: 10px">
                <!--	搜索/选择标签	-->
                <div style="margin-left: 25px">
                    <select class="selectpicker" multiple data-live-search="true" data-max-options="1">
                        <option>大三</option>
                        <option>考研</option>
                        <option>学习</option>
                        <option>复习</option>
                    </select>
                    <!--	添加标签按钮 	-->
                </div>
                <i class="bi bi-plus-square addbutton" data-toggle="modal" data-target="#addTagModal"></i>
            </div>
        </fieldset>
        <fieldset>
            <legend>文件历史</legend>
            <table class="table files" style="background-color: white;table-layout: fixed;word-break:break-all;">
                <thead>
                <tr>
                    <th width="150">修改时间</th>
                    <th width="80">修改人</th>
                    <th width="50"></th>
                </tr>
                </thead>
                <tbody id="history">
                <tr></tr>
                <tr></tr>
                <tr>
                    <td class="action" style="color: #007bff">
                        <i class="bi bi bi-arrow-repeat" title="还原"></i>
                    </td>
                </tr>
                </tbody>
            </table>
        </fieldset>

    </ul>
</nav>

</div>

<div th:include="file_upload :: fileUpload"></div>
</body>
</html>

<script type="module">
    import httpUtil from "/static/httpUtil.js";
    // 文件详情
    $.fn.bindEventForMore = function bindEventMore(){
        $(".more").click(function (e) {
            $(".drawer").drawer("open")
            $(".drawer-nav").addClass("col-my-drawer")
            // httpUtil.get("/getFileHistory", {
            //     params: {
            //         fileId: e.target.getAttribute("userFileId")
            //     }
            // })
            //     .then(res => {
            //     $("#history tr").remove()
            //     for (let i = 0; i < res.data.length; i++) {
            //         $("#history").append('<tr><td>' + res.data[i].updatedTime + '</td><td>' + res.data[i].updatePerson +
            //             '</td><td class="action" style="color: #007bff"><i class="bi bi bi-arrow-repeat" title="还原"></i></td></tr>')
            //     }
            // })
            // httpUtil.get("/fileInfo",JSON.stringify({
            //     id:e.target.getAttribute("userFileId")
            // })).then(res=>{
            //     // console.log(res)
            // })
        })
    }
    // 文件分享
    $.fn.bindEventForShare = function bindEventShare(){
        $(".bi-share").click(function (){
            $.fn.shareManage($(this).parent().siblings().eq(1).children("svg").attr("userfileid"),
                $(this).parent().siblings().eq(1).text(),
                $(this).parent().siblings().eq(1).children("svg").attr("filetype").toLowerCase()
            )
        });
    }
    $(function () {
        let method = 'copy'
        $("#copy").click(function () {
            method = 'copy'
            $.fn.selectDirForUser.show()
        })
        $("#move").click(function () {
            method = 'move'
            $.fn.selectDirForUser.show()
        })
        $.fn.selectDirForUser.ok(function (fileId, fileName) {
            let rows = $('#mTable').bootstrapTable('getSelections')
            console.log(rows)
            if (rows.length == 0) {
                layer.msg("请选择要操作的文件");
                return;
            }
            let ids = [];
            for (let row of rows) {
                ids.push(row.userFileId)
            }
            httpUtil.post("/file/"+method, JSON.stringify({
                ids: ids,
                target: fileId
            })).then(res => {
                unCheckAll()
                initTable()
            })
        })

        $("#addfolderconfirm").click(function () {
            $("#addfolderModel").modal("hide")
            if(path == "")
                path = '/'
            httpUtil.post("/file/createDirectory", JSON.stringify({
                path: path,
                fileName: $("#newfolder").val()
            })).then(res => {
                initTable()
                $("#newfolder").val("");
            })
        })
        $("#confirmDeletion").click(function () {
            let rows = $('#mTable').bootstrapTable('getSelections')
            $("#deleteConfirmation").modal("hide")
            console.log(rows.length)
            if (rows.length == 0) {
                layer.msg("请选择要操作的文件");
                return;
            }
            let ids = [];
            for (let row of rows) {
                ids.push(row.userFileId)
            }
            httpUtil.post("/file/deleted", JSON.stringify({
                ids: ids
            })).then(res => {
                unCheckAll()
                initTable()
            }).catch(e => {
                layer.msg("请求失败");
            })
        })
        $("#renameconfirm").click(function () {
            let rows = $('#mTable').bootstrapTable('getSelections')
            if (rows.length == 0) {
                layer.msg("请选择要操作的文件");
                return;
            }
            // if (rows.length > 1) {
            //     layer.msg("不可为多个文件同时重命名");
            //     return;
            // }
            if (rows[0].fileName == $("#newname").val().trim()) {
                layer.msg("文件名未改变，请重新输入");
                return;
            }
            if($("#newname").val().trim() == ""){
                layer.msg("请输入新文件名")
                return
            }
            $("#renameModel").modal("hide")
            httpUtil.post("/file/rename", JSON.stringify({
                fileName: $("#newname").val().trim(),
                fileId: rows[0].userFileId
            })).then(res => {
                unCheckAll()
                initTable()
                $("#newname").val("");
            })
        })

        // 上传文件(夹)
        $("#uploadFileMenuItem").click(function(){
            $("#file").click();
        })
        $("#uploadFolderMenuItem").click(function(){
            $("#files").click();
        })
    })
</script>
<script>
    let path = "[[${path}]]"
    $(function () {                 //页面加载完成后执行事件
        // 初始化
        initTable()                 // 文件列表初始化
        $('.drawer').drawer();      // 抽屉初始化

        // 文件详情事件
        $(".drawer-overlay").click(function () {
            $(".drawer-nav").removeClass("col-my-drawer")
            $(".drawer").drawer("close")
        })   // 单击遮罩层，关闭文件详情(并减少宽度)
        $(window).resize(function () {
            $(".drawer-nav").removeClass("col-my-drawer")
            $(".drawer").drawer("close")
});            // 调整窗口大小时，移除抽屉宽度

        // 返回上级目录
        $("#parentBtn").click(function(){
            // 最后一级空目录情况
            if(typeof($("td svg").attr("filetype")) == 'undefined'){
                let p = path
                p = p.substring(0, p.lastIndexOf('/'))
                path = p.substring(0, p.lastIndexOf('/')+1)
            }
            // 非第一级目录
             else if($(this).attr("parentPath") != '/'){
                let p = $(this).attr("parentPath")
                p = p.substring(0, p.lastIndexOf('/'))
                path = p.substring(0, p.lastIndexOf('/')+1)
            }
            else        // 第1级目录
                path = $(this).attr("parentPath")
            initTable()
            unCheckAll()        // 清空选中状态
            $(this).attr("disabled", "disabled")
        })
        // 模糊查找当前目录下的文件
        $("#searchBtn").click(function(){
            if($("#searchInput").val().trim() != ""){
                queryFile()
            }
            $("#searchInput").val("")
        })              // 点击按钮搜索
        $("#searchInput").on("keypress", function(e){
            if(e.keyCode == 13) {
                queryFile()
                $("#searchInput").val("")
            }
        })  // 回车搜索
    });

    // 初始化表格数据
    function initTable() {
        // 先销毁表格
        $('#mTable').bootstrapTable('destroy');
        $('#mTable').bootstrapTable({
            url: "/main/data",   //请求后台的URL（*）
            method: 'get',
            dataField: 'data',              // 设置数据域
            data_local: "zh-US",            // 表格汉化
            classes: 'table',               // 表格 样式类
            height: 720,                    // 表格高度
            queryParams: function (params) {  // 查询 和 请求响应
                return {
                    path: path
                };
            },
            // responseHandler: function (res) {
            //     console.log(res)
            //     return res
            // },
            columns: [
                {
                    checkbox: true,
                },
                {
                    field: "fileType",
                    title: "文件类型",
                    align: "center",
                    visible: false
                },
                {
                    field: 'fileName',
                    title: '文件名',
                    align: 'left',
                    halign: "center",
                    formatter: function fileNameFormatter(value, row, index) {
                        let fName = value
                        value = "<svg fileType="+ row.fileType +" userFileId='"+ row.userFileId +"' parentPath='"+ row.fileParentPath +"' shareId='"+ row.shareId +"' " +
                            "currentPath='"+ row.currentPath +"' class='icon mr-2' style='margin-left: 30%;' aria-hidden='true'>"

                        if(fileTypeSet.has(row.fileType))
                            value += "<use xlink:href='#icon-"+ row.fileType.toLowerCase() +"'></use>"
                        else
                            value += "<use xlink:href='#icon-other'></use>"
                        return value + "</svg>" + fName
                    }
                },
                {
                    field: "operation",
                    align: 'center',
                    width:230,
                    formatter: function operationFormatter(value, row, index){
                        value = '<i class="bi bi-share" title="分享" data-toggle="modal" data-target="#shareMain"></i>'
                        if(row.fileType != 'DIR')
                            value += '<i class="bi bi-download" title="下载"></i>' +
                                    '<i class="bi bi-three-dots more drawer-toggle" title="更多" userFileId="'+ row.userFileId +'"' + '></i>'
                        return value
                    }
                },
                {
                    field: 'fileSize',
                    title: '文件大小',
                    align: 'center',
                    formatter: function fileSizeFormatter(value, row, index) {
                        if(row.fileType == "DIR"){
                            return '-'
                        }
                        return convertFileSize(value)
                    }
                },
                {
                    field: 'createdTime',
                    title: '创建时间',
                    align: 'center',
                    formatter: function indexFormatter(value, row, index) {
                        return value.replace("T"," ")
                    }
                },
                {
                    field: 'updatedTime',
                    title: '更新时间',
                    align: 'center',
                    formatter: function dateFormatter(value, row, index) {
                        return value.replace("T"," ")
                    }
                },
            ],
            onPostBody: function (data){
                // 设置样式
                $(".files td i").addClass(".files td i");
                // 显示文件数量 & 上级目录 & 查询按钮
                if(typeof(data[0]) != "undefined"){
                    $("#fileNumber").text(data[0].fileNumber)
                    $("#parentBtn").attr("parentPath", data[0].fileParentPath)
                    $("#searchBtn").attr("parentPath", data[0].fileParentPath)
                }
                // 空目录情况
                else{
                    $("#fileNumber").text(0)
                }
                $("svg[filetype='DIR']").parent().addClass("pointer")
                // 单击文件分享，查看内部文件
                $("svg[filetype='DIR']").parent().click(function(){
                    path = $(this).children("svg").attr("parentpath") +　$(this).children("svg").attr("userfileid") + "/"
                    unCheckAll()        // 清空选中状态
                    initTable()
                })
                $("#parentBtn").removeAttr("disabled")
                // 文件详情
                $.fn.bindEventForMore()
                // 文件分享
                $.fn.bindEventForShare()
            },
            onCheck: function(row, $element){
                let rows = $('#mTable').bootstrapTable('getSelections')
                // $("#reduction")[0].removeAttribute("disabled");
                $("#download")[0].removeAttribute("disabled");
                $("#rename")[0].removeAttribute("disabled");
                $("#deleted")[0].removeAttribute("disabled");
                $("#copy")[0].removeAttribute("disabled");
                $("#move")[0].removeAttribute("disabled");
                if (rows.length > 1) {      // 不可同时 下载多个文件 & 为多个文件重命名
                    $("#rename")[0].setAttribute("disabled", "disabled");
                    $("#download")[0].setAttribute("disabled", "disabled");
                }
            },
            onUncheck: function(row, $element){
                let rows = $('#mTable').bootstrapTable('getSelections')
                // $("#reduction")[0].removeAttribute("disabled");
                if(rows.length == 1){
                    $("#rename")[0].removeAttribute("disabled", "disabled");
                    $("#download")[0].removeAttribute("disabled", "disabled");
                }
                else if(rows.length == 0){
                    unCheckAll()
                }
            },
            onCheckAll: function (rowsAfter,rowsBefore) {
                $("#deleted")[0].removeAttribute("disabled");
                $("#copy")[0].removeAttribute("disabled");
                $("#move")[0].removeAttribute("disabled");
                $("#rename")[0].setAttribute("disabled", "disabled");
                $("#download")[0].setAttribute("disabled", "disabled");
            },
            onUncheckAll: function (rowsAfter,rowsBefore) {
                unCheckAll()
            }
        })

    }
    // 查询当前目录下的文件
    function queryFile() {
        // 先销毁表格
        $('#mTable').bootstrapTable('destroy');
        $('#mTable').bootstrapTable({
            url: "/main/query",               //请求后台的URL（*）
            method: 'get',
            dataField: 'list',
            totalField: 'total',
            pagination: true,                 // 设置为 true 会在表格底部显示分页条。
            pageList: [10, 20, 30, 40],       // 可供选择的每页的行数（*），当记录条数大于最小可选择条数时才会出现
            sidePagination: 'server',         // 分页处理方式
            data_local: "zh-US",              // 表格汉化
            classes: 'table',                 // 表格 样式类
            height: 720,                      // 表格高度
            queryParams: function (params) {       // 查询 和 请求响应
                return {
                    pageNum: params.offset / params.limit + 1,  // 当前页码
                    pageSize: params.limit,
                    fileName: $("#searchInput").val().trim(),
                    fileParentPath: $("#searchBtn").attr("parentPath")
                };
            },
            responseHandler: function(res){
                return res.data;
            },
            columns: [
                {
                    checkbox: true,
                },
                {
                    field: "fileType",
                    title: "文件类型",
                    align: "center",
                    visible: false
                },
                {
                    field: 'fileName',
                    title: '文件名',
                    align: 'left',
                    halign: "center",
                    formatter: function fileNameFormatter(value, row, index) {
                        let fName = value
                        value = "<svg fileType="+ row.fileType +" userFileId='"+ row.userFileId +"' parentPath='"+ row.fileParentPath +"' shareId='"+ row.shareId +"' " +
                            "currentPath='"+ row.currentPath +"' class='icon mr-2' style='margin-left: 30%;' aria-hidden='true'>"

                        if(fileTypeSet.has(row.fileType))
                            value += "<use xlink:href='#icon-"+ row.fileType.toLowerCase() +"'></use>"
                        else
                            value += "<use xlink:href='#icon-other'></use>"
                        return value + "</svg>" + fName
                    }
                },
                {
                    field: "operation",
                    align: 'center',
                    width:230,
                    formatter: function operationFormatter(value, row, index){
                        value = '<i class="bi bi-share" title="分享" data-toggle="modal" data-target="#shareMain"></i>'
                        if(row.fileType != 'DIR')
                            value += '<i class="bi bi-download" title="下载"></i>' +
                                '<i class="bi bi-three-dots more drawer-toggle" userFileId="'+ row.userFileId +'" title="更多" userFileId="'+ row.userFileId +'"' + '></i>'
                        return value
                    }
                },
                {
                    field: 'fileSize',
                    title: '文件大小',
                    align: 'center',
                    formatter: function fileSizeFormatter(value, row, index) {
                        if(row.fileType == "DIR"){
                            return '-'
                        }
                        return convertFileSize(value)
                    }
                },
                {
                    field: 'createdTime',
                    title: '创建时间',
                    align: 'center',
                    formatter: function indexFormatter(value, row, index) {
                        return value.replace("T"," ")
                    }
                },
                {
                    field: 'updatedTime',
                    title: '更新时间',
                    align: 'center',
                    formatter: function dateFormatter(value, row, index) {
                        return value.replace("T"," ")
                    }
                },
            ],
            onPostBody: function (data){
                unCheckAll()
                // 显示文件数量 & 上级目录 & 查询按钮
                if(data.length != 0){
                    $("#fileNumber").text(data.length)
                    // $("#parentBtn").attr("parentPath", '/')
                }else
                    $("#fileNumber").text(0)
                $("svg[filetype='DIR']").parent().addClass("pointer")
                // 单击文件分享，查看内部文件
                $("svg[filetype='DIR']").parent().click(function(){
                    path = $(this).children("svg").attr("parentpath") +　$(this).children("svg").attr("userfileid") + "/"
                    unCheckAll()        // 清空选中状态
                    initTable()
                })
                // 文件详情
                $.fn.bindEventForMore()
                // 文件分享
                $.fn.bindEventForShare()
            },
            onCheck: function(row, $element){
                let rows = $('#mTable').bootstrapTable('getSelections')
                // $("#reduction")[0].removeAttribute("disabled");
                $("#download")[0].removeAttribute("disabled");
                $("#rename")[0].removeAttribute("disabled");
                $("#deleted")[0].removeAttribute("disabled");
                $("#copy")[0].removeAttribute("disabled");
                $("#move")[0].removeAttribute("disabled");
                if (rows.length > 1) {      // 不可同时 下载多个文件 & 为多个文件重命名
                    $("#rename")[0].setAttribute("disabled", "disabled");
                    $("#download")[0].setAttribute("disabled", "disabled");
                }
            },
            onUncheck: function(row, $element){
                let rows = $('#mTable').bootstrapTable('getSelections')
                // $("#reduction")[0].removeAttribute("disabled");
                if(rows.length == 1){
                    $("#rename")[0].removeAttribute("disabled", "disabled");
                    $("#download")[0].removeAttribute("disabled", "disabled");
                }
                else if(rows.length == 0){
                    unCheckAll()
                }
            },
            onCheckAll: function (rowsAfter,rowsBefore) {
                $("#deleted")[0].removeAttribute("disabled");
                $("#copy")[0].removeAttribute("disabled");
                $("#move")[0].removeAttribute("disabled");
                $("#rename")[0].setAttribute("disabled", "disabled");
                $("#download")[0].setAttribute("disabled", "disabled");
            },
            onUncheckAll: function (rowsAfter,rowsBefore) {
                unCheckAll()
            }
        })
    }
    // 取消全选，按钮全不可用
    function unCheckAll(){
        // $("#reduction")[0].setAttribute("disabled", "disabled");
        $("#download")[0].setAttribute("disabled", "disabled");
        $("#rename")[0].setAttribute("disabled", "disabled");
        $("#deleted")[0].setAttribute("disabled", "disabled");
        $("#copy")[0].setAttribute("disabled", "disabled");
        $("#move")[0].setAttribute("disabled", "disabled");
    }
</script>