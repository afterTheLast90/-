<!DOCTYPE html>
<html lang="zh-CN" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
	<!-- 引入popper.js	-->
<!--	<script src="/static/popper/popper.min.js"></script>-->

	<th:block th:include="common/header :: header(~{::title})">
		<title>分享文件</title>
	</th:block>
	<script src="/static/converFileSize.js"></script>

	<style>
    .main {
      display: flex;
      height: calc(100vh - 20vh);
      width: 100%;
      overflow-y: hidden;
      margin-top: 10px;
      font-size: 1.5rem;
    }

    .rMain {
      padding-left: 15px;
      padding-right: 15px;
      background-color: #fff;
      overflow: auto;
    }

    #expireTime{
      margin-left: 3%;
      line-height: 1.5rem;
	    font-size: 1rem;
	    color: #5a6268;
    }

    .modal-backdrop.show{
	    opacity: 0.3;
    }

    .computerIcon {
      width: 1.5em;
      height: 1.5em;
      vertical-align: -0.4em;
      fill: currentColor;
      overflow: hidden;
    }

    #phoneLogin {
      max-height: 79vh;
      overflow-y: auto;
      overflow-x: hidden;
    }

    #fileList{
      padding-left: 0;
    }

    #fileList li {
      position: relative;
      margin-left: 0;
      margin-right: 0;
      padding-left: 2rem;
      list-style: none;
      border-bottom: 1px solid #ccc;
    }

    .phoneIcon {
      margin-left: .3rem;
      width: 12vw;
      height: 12vh;
      vertical-align: -0.15em;
      fill: currentColor;
      overflow: hidden;
    }


    #fileList .fileInfo {
      margin-top: .8rem;
      margin-left: .2rem;
      height: 12vh;
      width: 50vw;
      text-align: left;
    }

    #pFileName {
      margin-top: .5rem;
      margin-left: .4rem;
      font-size: 1.5rem;
    }

    #pExpireTime {
      /*margin-top: -.8rem;*/
      margin-left: .5rem;
    }

    .pDownload {
      position: absolute;
      font-size: 2rem;
      color: #1296db;
      top: 20%;
      right: 8%;
    }
	</style>

	<script type="module">
			import httpUtil from "../static/httpUtil.js";
			let userFileId
			let shareId
      $(function(){
          // 密码未验证成功
			    if([[${not pwdPass}]]){
              $("#pwdCheck").modal("show")
					    setTimeout(function(){
                  layer.msg("[[${msg}]]")
					    }, 200)
			    }
			    else {
              if(!isPhoneLogin()){        // 电脑端
                  $("#phoneLogin").hide()
                  $("#computerLogin").show()
		              // 渲染电脑端数据
                  httpUtil.get("/s/shareInfo", {
                      params: {
                          shareId: "[[${shareId}]]",
                          currentPath: "init"
                      }
                  })
                      .then(res => {
                          if(fileTypeSet.has(res.data[0].fileType)){
                              $("#computerLogin div section svg use").attr("xlink:href", "#icon-"+res.data[0].fileType.toLowerCase())
                          }
                          else
                              $("#computerLogin div section svg use").attr("xlink:href", "#icon-other")
                          $("#fileName").text(res.data[0].fileName)
                          $("#expireTime b").text(res.data[0].expireTime.replace("T", " ") == '1970-01-01 07:59:59' ? "永久" : res.data[0].expireTime.replace("T", " "))
                          // 文件大小
                          $("#fileSize").text(convertFileSize(res.data[0].fileSize))
                          $("#dumpBtn").attr("userFileId", res.data[0].userFileId)
                          $("#dumpBtn").attr("shareId", res.data[0].shareId)
                          $("#downBtn").attr("href", '/shareDownload?userFileId='+ res.data[0].userFileId +'&shareId='+ res.data[0].shareId)
                          // 是否还有 下载/转存 次数
                          if (!res.data[0].haveDown) {
                              $("#downBtn").prop("disabled", "disabled")
                          }
                          if (!res.data[0].haveDump) {
                              $("#dumpBtn").prop("disabled", "disabled")
                          }
                          // 转存按钮
                          $("#dumpBtn").click(function () {
                              userFileId = $(this).attr("userFileId")
                              shareId = $(this).attr("shareId")
                              $.fn.selectDirForUser.show()
                          })
                      })
              }
              else {                      // 手机端
                  $("#computerLogin").hide()
                  $("body").css("minWidth", "320px")
                  $("#phoneLogin").show()
                  // 渲染手机端数据
                  httpUtil.get("/s/shareInfo", {
                      params:{
                          shareId: "[[${shareId}]]",
                          currentPath: "init"
                      }
                  })
                      .then(res => {
                          let expireTime
                          $("#fileList").html("")
                          for(let data of res.data){
                              expireTime = data.expireTime.replace("T", " ")
                              expireTime = expireTime=='1970-01-01 07:59:59'?'永久':expireTime

		                          let value = "<li>\n" +
                                  "<div class='row'>\n" +
                                  "<svg fileType='"+ data.fileType +"' userFileId='"+ data.userFileId +"' currentPath='"+ data.currentPath +"' class='phoneIcon' aria-hidden='true' >\n"
                              if(fileTypeSet.has(data.fileType))
																	value += "<use xlink:href='#icon-"+ data.fileType.toLowerCase() +"'></use>\n"
		                          else
		                              value += "<use xlink:href='#icon-other'></use>\n"
		                          value +=  "</svg>\n" +
			                                  "<div class='fileInfo'>\n" +
			                                  "<span id='pFileName' class='row'>"+ data.fileName +"</span>\n" +
			                                  "<div id='pExpireTime' class='row'>"+ expireTime +"</div>\n" +
			                                  "</div>\n" +
			                                  "<a href='/shareDownload?userFileId="+ data.userFileId +"&shareId="+ data.shareId +"' class='bi bi-download pDownload'></a>\n" +
			                                  "</div>\n" +
			                                  "</li>"

                              $("#fileList").append(value)
                          }
                      })
              }
			    }
			    // 密码验证
			    $("#pwdCheckBtn").click(function(){
			        if($("input[name='pwd']").val().trim().length != 6){
			            layer.msg("请输入6位密码")
			        }
			        else{
			            $("form").attr("action", "/s/[[${shareId}]]")
							    $("form").submit()
              }
			    })
		      // 取消分享
		      $("#cancelShareBtn").click(function(){
							$("#cancelShareModal").modal("show")
		      })
		      // 确认取消分享
		      $("#cancelShareConfirm").click(function(){
              httpUtil.put("/share/closeShare/"+"[[${shareId}]]")
                  .then(res =>{
                      setTimeout(function (){
                          $("form").attr("action", "/s/[[${shareId}]]")
                          $("form").submit()
                      }, 500)
                  })
		      })

          // 得到保存路径
          $.fn.selectDirForUser.ok(function(fileId, fileName){
              let ids=[]
              var shareIds=[]
              ids.push(userFileId)
              shareIds.push(shareId)
              httpUtil.post("/resource/dump", JSON.stringify({
                  userFileIds:ids,
                  shareIds:shareIds,
                  targetPath:fileId
              }))
                  .then(function(){
                      window.location.reload()
                  })
          })
		})

      // 判断是否手机登录
      function isPhoneLogin(){
          let system ={};
          let p = navigator.platform;
          system.win = p.indexOf("Win") == 0;
          system.mac = p.indexOf("Mac") == 0;
          system.x11 = (p == "X11") || (p.indexOf("Linux") == 0);
          if(system.win||system.mac || system.xll){//如果是电脑跳转到
              return false
          }else{  //如果是手机,跳转到
              return true
          }
      }
	</script>


</head>

<body>
<div th:replace="common/nav-header :: nav-header"></div>
<!-- 电脑端显示 -->
<div th:if="${pwdPass}" class="row main mb-2 mt-2" id="computerLogin" style="margin-top:8px;">
	<!-- 主内容区 	-->
	<div class="rMain container shadow">
		<!--	分享信息	-->
		<section class="fileInfo mt-3">
			<!--	图标		-->
			<svg fileType="" class='computerIcon ml-4 mr-1' aria-hidden='true'>
				<use xlink:href=''></use>
			</svg>
			<!--	文件名		-->
			<span id="fileName" class="pb-2"></span>
			<!--	过期时间		-->
			<span id="expireTime">
				过期时间: <i class="bi bi-stopwatch pl-2"></i><b style="font-weight: normal;"></b>
			</span>
			<div class="float-right">
				<button class="btn btn-primary mr-3" id="cancelShareBtn" th:if="${isOwner}"><i class="bi bi-cloud-slash pr-2" ></i>取消分享</button>
				<!--		不是所有者 且 登录才能保存文件		-->
				<button  class="btn btn-primary mr-3" id="dumpBtn" th:if="${(not isOwner) and isLogin}"><i class="bi bi-box-arrow-in-right pr-2"></i>保存到网盘</button>
				<a class="btn btn-primary" id="downBtn">
					<i class="bi bi-box-arrow-in-down"></i>
					下载(<span id="fileSize"></span>)
				</a>
			</div>
		</section>
		<!--	文件预览	-->
		<section></section>
	</div>
	<!-- 取消分享模态框 -->
	<div class="modal fade" id="cancelShareModal">
		<div class="modal-dialog modal-sm">
			<div class="modal-content">
				<!-- 模态框头部 -->
				<div class="modal-header">
					<h5 class="modal-title">确认操作</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<!-- 模态框主体 -->
				<div class="modal-body py-4 mx-2">
					<span>确认取消分享该文件?</span>
				</div>
				<!-- 模态框底部 -->
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" id="cancelShareConfirm">确定</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
				</div>
			</div>
		</div>
	</div>
	<!--选择目录模态框-->
	<div th:replace="common/selectDir :: selectDir"></div>
</div>
<!--  手机端显示  -->
<div th:if="${pwdPass}" id="phoneLogin" >
	<!--	返回上级目录 -->
	<!-- 文件列表	-->
	<ul id="fileList">
	</ul>
</div>
<div th:replace="common/footer :: footer"></div>

<!-- 密码检测模态框 -->
<div  th:if="${not pwdPass}" class="modal fade" id="pwdCheck" style="margin-top: 14%" data-backdrop="static">
	<div class="modal-dialog modal-md">
		<div class="modal-content">

			<!-- 模态框头部 -->
			<div class="modal-header">
				<h5 class="modal-title">
					<img th:src="${'/avatar/'+user.getUserId()}" alt="" class="rounded-circle" style="width: 35%;">
					<span class="userName ml-1 mt-1" th:text="${user.getUserName()}"></span>
				</h5>
			</div>

			<!-- 模态框主体 -->
			<div class="row mt-4 ml-5 mb-0">
				<label class="col-6">请输入密码：</label>
			</div>
			<form action="" method="get">
				<div class="modal-body ml-5 mt-0 pt-2 mb-5 row">
					<input type="text" class="form-control col-8" name="pwd" placeholder="请输入6位密码" required maxlength="6">
					<input type="button" class="btn btn-primary col-2 ml-2" id="pwdCheckBtn" value="确定">
				</div>
			</form>
		</div>
	</div>
</div>
</body>
</html>